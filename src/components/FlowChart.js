import React, { useState, useCallback, useMemo, useEffect } from 'react';
import ReactFlow, { 
  Background,
  Controls,
  MiniMap,
  addEdge,
  applyEdgeChanges,
  applyNodeChanges,
  Handle,
  Position,
  useReactFlow,
  ReactFlowProvider
} from 'reactflow';
import { Card, Button, Space, Layout, Input, Form, Radio, Dropdown, Menu, Divider, Select, message } from 'antd';
import { DeleteOutlined, UpOutlined, DownOutlined } from '@ant-design/icons';
import 'reactflow/dist/style.css';

const { Content } = Layout;

// ËäÇÁÇπÁ±ªÂûãÈÖçÁΩÆ
const NODE_TYPES = {
  prerequisite: {
    label: 'ÂâçÁΩÆÊù°‰ª∂',
    color: '#e6f4ff',  // ÊµÖËìùËâ≤ËÉåÊôØ
    borderColor: '#69b1ff',  // Ê∑±ËìùËâ≤ËæπÊ°Ü
    icon: 'üìã'
  },
  preCheck: {
    label: 'ÊâßË°åÂâçÊ£ÄÊü•',
    color: '#fff7e6',  // ÊµÖÊ©ôËâ≤ËÉåÊôØ
    borderColor: '#ffd591',  // Ê∑±Ê©ôËâ≤ËæπÊ°Ü
    icon: 'üîç'
  },
  atomicAnalysis: {
    label: 'ÂàÜÊûêÂéüÂ≠ê',
    color: '#f6ffed',  // ÊµÖÁªøËâ≤ËÉåÊôØ
    borderColor: '#b7eb8f',  // Ê∑±ÁªøËâ≤ËæπÊ°Ü
    icon: '‚öõÔ∏è'
  },
  analysisResult: {
    label: 'ÂàÜÊûêÁªìÊûú',
    color: '#f9f0ff',
    borderColor: '#d3adf7',
    icon: 'üìä'
  },
  analysisResource: {
    label: 'ÂàÜÊûêËµÑÊ∫ê',
    color: '#fff2f0',  // ÊµÖÁ∫¢Ëâ≤ËÉåÊôØ
    borderColor: '#ffccc7',  // Ê∑±Á∫¢Ëâ≤ËæπÊ°Ü
    icon: 'üìä'
  },
  dataModel: {
    label: 'Êï∞ÊçÆÊ®°Âûã',
    color: '#e6fffb',  // ÊµÖÈùíËâ≤ËÉåÊôØ
    borderColor: '#87e8de',  // Ê∑±ÈùíËâ≤ËæπÊ°Ü
    icon: 'üíæ'
  }
};

// ÂâçÁΩÆÊù°‰ª∂Ë°®ÂçïÁªÑ‰ª∂
const PrerequisiteForm = ({ data, onChange, isExpanded }) => {
  const handleChange = (field, value) => {
    onChange({
      ...data,
      [field]: value
    });
  };

  return (
    <div>
      <Form.Item label="Áî®‰æãID" style={{ marginBottom: 8 }}>
        <Input
          placeholder="ËØ∑ËæìÂÖ•Áî®‰æãID"
          value={data.caseId || ''}
          onChange={(e) => handleChange('caseId', e.target.value)}
          onClick={(e) => e.stopPropagation()}
        />
      </Form.Item>
      <Form.Item label="ÊòØÂê¶ÁîüÊïà" style={{ marginBottom: 8 }}>
        <Radio.Group
          value={data.isActive}
          onChange={(e) => handleChange('isActive', e.target.value)}
          onClick={(e) => e.stopPropagation()}
        >
          <Radio value={true}>ÊòØ</Radio>
          <Radio value={false}>Âê¶</Radio>
        </Radio.Group>
      </Form.Item>
      {isExpanded && (
        <>
          <Form.Item label="ËÆæÂ§áÂâçÁΩÆÊù°‰ª∂" style={{ marginBottom: 8 }}>
            <Input.TextArea
              placeholder="ËØ∑ËæìÂÖ•ËÆæÂ§áÂâçÁΩÆÊù°‰ª∂"
              value={data.conditions?.device || ''}
              onChange={(e) => handleChange('conditions', { ...data.conditions, device: e.target.value })}
              autoSize={{ minRows: 1, maxRows: 3 }}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
          <Form.Item label="Â≠êÊû∂ÂâçÁΩÆÊù°‰ª∂" style={{ marginBottom: 8 }}>
            <Input.TextArea
              placeholder="ËØ∑ËæìÂÖ•Â≠êÊû∂ÂâçÁΩÆÊù°‰ª∂"
              value={data.conditions?.subRack || ''}
              onChange={(e) => handleChange('conditions', { ...data.conditions, subRack: e.target.value })}
              autoSize={{ minRows: 1, maxRows: 3 }}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
          <Form.Item label="ÂçïÊùøÂâçÁΩÆÊù°‰ª∂" style={{ marginBottom: 8 }}>
            <Input.TextArea
              placeholder="ËØ∑ËæìÂÖ•ÂçïÊùøÂâçÁΩÆÊù°‰ª∂"
              value={data.conditions?.board || ''}
              onChange={(e) => handleChange('conditions', { ...data.conditions, board: e.target.value })}
              autoSize={{ minRows: 1, maxRows: 3 }}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
        </>
      )}
    </div>
  );
};

// Ê∑ªÂä†ÂàÜÊûêÂéüÂ≠êË°®ÂçïÁªÑ‰ª∂
const AtomicAnalysisForm = ({ data, onChange, isExpanded }) => {
  const handleChange = (field, value) => {
    onChange({
      ...data,
      [field]: value
    });
  };

  return (
    <div>
      <Form.Item label="ÂéüÂ≠êID" style={{ marginBottom: 8 }}>
        <Input
          placeholder="ËØ∑ËæìÂÖ•ÂéüÂ≠êID"
          value={data.atomicId || ''}
          onChange={(e) => handleChange('atomicId', e.target.value)}
          onClick={(e) => e.stopPropagation()}
        />
      </Form.Item>
      {isExpanded && (
        <>
          <Form.Item label="ÂàÜÊûêËßÑÂàô" style={{ marginBottom: 8 }}>
            <Input.TextArea
              placeholder="ËØ∑ËæìÂÖ•ÂàÜÊûêËßÑÂàô"
              value={data.analysisRule || ''}
              onChange={(e) => handleChange('analysisRule', e.target.value)}
              autoSize={{ minRows: 1, maxRows: 3 }}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
          <Form.Item label="ÂèÇÊï∞Âà∑Êñ∞" style={{ marginBottom: 8 }}>
            <Input.TextArea
              placeholder="ËØ∑ËæìÂÖ•ÂèÇÊï∞Âà∑Êñ∞"
              value={data.parameterRefresh || ''}
              onChange={(e) => handleChange('parameterRefresh', e.target.value)}
              autoSize={{ minRows: 1, maxRows: 3 }}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
        </>
      )}
    </div>
  );
};

// Ê∑ªÂä†ÊâßË°åÂâçÊ£ÄÊü•Ë°®ÂçïÁªÑ‰ª∂
const PreCheckForm = ({ data, onChange, isExpanded }) => {
  const handleChange = (field, value) => {
    onChange({
      ...data,
      [field]: value
    });
  };

  return (
    <div>
      <Form.Item label="ÂàÜÊûêÈ°πID" style={{ marginBottom: 8 }}>
        <Input
          placeholder="ËØ∑ËæìÂÖ•ÂàÜÊûêÈ°πID"
          value={data.analysisItemId || ''}
          onChange={(e) => handleChange('analysisItemId', e.target.value)}
          onClick={(e) => e.stopPropagation()}
        />
      </Form.Item>
      {isExpanded && (
        <Form.Item label="Ê£ÄÊü•Êù°‰ª∂" style={{ marginBottom: 8 }}>
          <Input.TextArea
            placeholder="ËØ∑ËæìÂÖ•Ê£ÄÊü•Êù°‰ª∂"
            value={data.checkCondition || ''}
            onChange={(e) => handleChange('checkCondition', e.target.value)}
            autoSize={{ minRows: 1, maxRows: 3 }}
            onClick={(e) => e.stopPropagation()}
          />
        </Form.Item>
      )}
    </div>
  );
};

// ‰øÆÊîπÊï∞ÊçÆÊ®°ÂûãË°®ÂçïÁªÑ‰ª∂
const DataModelForm = ({ data, onChange, isExpanded }) => {
  const handleChange = (field, value) => {
    onChange({
      ...data,
      [field]: value
    });
  };

  // Êõ¥Êñ∞Ëß£ÊûêÁ±ªÂûãÈÄâÈ°πÔºåÊ∑ªÂä† multi_table_value
  const parseTypeOptions = [
    { label: 'dump_table_value', value: 'dump_table_value' },
    { label: 'custom_table_value', value: 'custom_table_value' },
    { label: 'chipreg_table_value', value: 'chipreg_table_value' },
    { label: 'multi_table_value', value: 'multi_table_value' }
  ];

  // ËøûË°®ÊñπÂºèÈÄâÈ°π
  const joinTypeOptions = [
    { label: 'Â∑¶ËøûÊé•', value: 'left_join' },
    { label: 'Âè≥ËøûÊé•', value: 'right_join' },
    { label: 'ÂÜÖËøûÊé•', value: 'inner_join' },
    { label: 'Â§ñËøûÊé•', value: 'outer_join' },
    { label: 'ÂûÇÁõ¥ËøûÊé•', value: 'vertical_join' }
  ];

  // Ê†πÊçÆËß£ÊûêÁ±ªÂûãÊ∏≤ÊüìÈ¢ùÂ§ñÁöÑËæìÂÖ•Ê°Ü
  const renderExtraFields = () => {
    switch (data.parseType) {
      case 'dump_table_value':
        return (
          <>
            <Form.Item label="ÂºÄÂßãÊ†áËÆ∞" style={{ marginBottom: 8 }}>
              <Input.TextArea
                placeholder="ËØ∑ËæìÂÖ•ÂºÄÂßãÊ†áËÆ∞"
                value={data.startMark || ''}
                onChange={(e) => handleChange('startMark', e.target.value)}
                autoSize={{ minRows: 1, maxRows: 3 }}
                onClick={(e) => e.stopPropagation()}
              />
            </Form.Item>
            <Form.Item label="ÁªìÊùüÊ†áËÆ∞" style={{ marginBottom: 8 }}>
              <Input.TextArea
                placeholder="ËØ∑ËæìÂÖ•ÁªìÊùüÊ†áËÆ∞"
                value={data.endMark || ''}
                onChange={(e) => handleChange('endMark', e.target.value)}
                autoSize={{ minRows: 1, maxRows: 3 }}
                onClick={(e) => e.stopPropagation()}
              />
            </Form.Item>
            <Form.Item label="Ë°åÊ≠£ÂàôÂåπÈÖç" style={{ marginBottom: 8 }}>
              <Input.TextArea
                placeholder="ËØ∑ËæìÂÖ•Ë°åÊ≠£ÂàôÂåπÈÖç"
                value={data.lineRegex || ''}
                onChange={(e) => handleChange('lineRegex', e.target.value)}
                autoSize={{ minRows: 1, maxRows: 3 }}
                onClick={(e) => e.stopPropagation()}
              />
            </Form.Item>
            <Form.Item label="Ë°®Â§¥" style={{ marginBottom: 8 }}>
              <Input.TextArea
                placeholder="ËØ∑ËæìÂÖ•Ë°®Â§¥"
                value={data.tableHeader || ''}
                onChange={(e) => handleChange('tableHeader', e.target.value)}
                autoSize={{ minRows: 1, maxRows: 3 }}
                onClick={(e) => e.stopPropagation()}
              />
            </Form.Item>
            <Form.Item label="È¢ùÂ§ñÊìç‰Ωú" style={{ marginBottom: 8 }}>
              <Input.TextArea
                placeholder="ËØ∑ËæìÂÖ•È¢ùÂ§ñÊìç‰Ωú"
                value={data.extraOperation || ''}
                onChange={(e) => handleChange('extraOperation', e.target.value)}
                autoSize={{ minRows: 1, maxRows: 3 }}
                onClick={(e) => e.stopPropagation()}
              />
            </Form.Item>
          </>
        );
      case 'custom_table_value':
      case 'chipreg_table_value':
        return (
          <>
            <Form.Item label="Ë°®Â§¥" style={{ marginBottom: 8 }}>
              <Input.TextArea
                placeholder="ËØ∑ËæìÂÖ•Ë°®Â§¥"
                value={data.tableHeader || ''}
                onChange={(e) => handleChange('tableHeader', e.target.value)}
                autoSize={{ minRows: 1, maxRows: 3 }}
                onClick={(e) => e.stopPropagation()}
              />
            </Form.Item>
            <Form.Item label="È¢ùÂ§ñÊìç‰Ωú" style={{ marginBottom: 8 }}>
              <Input.TextArea
                placeholder="ËØ∑ËæìÂÖ•È¢ùÂ§ñÊìç‰Ωú"
                value={data.extraOperation || ''}
                onChange={(e) => handleChange('extraOperation', e.target.value)}
                autoSize={{ minRows: 1, maxRows: 3 }}
                onClick={(e) => e.stopPropagation()}
              />
            </Form.Item>
          </>
        );
      case 'multi_table_value':
        return (
          <>
            <Form.Item label="ËøûË°®ÊñπÂºè" style={{ marginBottom: 8 }}>
              <Select
                placeholder="ËØ∑ÈÄâÊã©ËøûË°®ÊñπÂºè"
                value={data.joinType}
                onChange={(value) => handleChange('joinType', value)}
                onClick={(e) => e.stopPropagation()}
                style={{ width: '100%' }}
                options={joinTypeOptions}
              />
            </Form.Item>
            <Form.Item label="ËøûË°®Â≠óÊÆµ" style={{ marginBottom: 8 }}>
              <Input.TextArea
                placeholder="ËØ∑ËæìÂÖ•ËøûË°®Â≠óÊÆµ"
                value={data.joinFields || ''}
                onChange={(e) => handleChange('joinFields', e.target.value)}
                autoSize={{ minRows: 1, maxRows: 3 }}
                onClick={(e) => e.stopPropagation()}
              />
            </Form.Item>
            <Form.Item label="È¢ùÂ§ñÊìç‰Ωú" style={{ marginBottom: 8 }}>
              <Input.TextArea
                placeholder="ËØ∑ËæìÂÖ•È¢ùÂ§ñÊìç‰Ωú"
                value={data.extraOperation || ''}
                onChange={(e) => handleChange('extraOperation', e.target.value)}
                autoSize={{ minRows: 1, maxRows: 3 }}
                onClick={(e) => e.stopPropagation()}
              />
            </Form.Item>
          </>
        );
      default:
        return null;
    }
  };

  return (
    <div>
      <Form.Item label="Ê®°ÂûãID" style={{ marginBottom: 8 }}>
        <Input
          placeholder="ËØ∑ËæìÂÖ•Ê®°ÂûãID"
          value={data.modelId || ''}
          onChange={(e) => handleChange('modelId', e.target.value)}
          onClick={(e) => e.stopPropagation()}
        />
      </Form.Item>
      {isExpanded && (
        <>
          <Form.Item label="Ëß£ÊûêÁ±ªÂûã" style={{ marginBottom: 8 }}>
            <Select
              placeholder="ËØ∑ÈÄâÊã©Ëß£ÊûêÁ±ªÂûã"
              value={data.parseType}
              onChange={(value) => handleChange('parseType', value)}
              onClick={(e) => e.stopPropagation()}
              style={{ width: '100%' }}
              options={parseTypeOptions}
            />
          </Form.Item>
          {renderExtraFields()}
        </>
      )}
    </div>
  );
};

// Ê∑ªÂä†ÂàÜÊûêÁªìÊûúË°®ÂçïÁªÑ‰ª∂
const AnalysisResultForm = ({ data, onChange, isExpanded }) => {
  const handleChange = (field, value) => {
    onChange({
      ...data,
      [field]: value
    });
  };

  // ‰∏•ÈáçÁ∫ßÂà´ÈÄâÈ°π
  const severityOptions = [
    { label: 'ÊèêÁ§∫', value: 'hint' },
    { label: '‰∏çËææÊ†á', value: 'unqualified' },
    { label: '‰∏•Èáç‰∏çËææÊ†á', value: 'severely_unqualified' }
  ];

  return (
    <div>
      <Form.Item label="ÂàÜÊûêÁªìÊûúID" style={{ marginBottom: 8 }}>
        <Input
          placeholder="ËØ∑ËæìÂÖ•ÂàÜÊûêÁªìÊûúID"
          value={data.resultId || ''}
          onChange={(e) => handleChange('resultId', e.target.value)}
          onClick={(e) => e.stopPropagation()}
        />
      </Form.Item>
      {isExpanded && (
        <>
          <Form.Item label="‰∏•ÈáçÁ∫ßÂà´" style={{ marginBottom: 8 }}>
            <Select
              placeholder="ËØ∑ÈÄâÊã©‰∏•ÈáçÁ∫ßÂà´"
              value={data.severityLevel}
              onChange={(value) => handleChange('severityLevel', value)}
              onClick={(e) => e.stopPropagation()}
              style={{ width: '100%' }}
            >
              {severityOptions.map(option => (
                <Select.Option key={option.value} value={option.value}>
                  {option.label}
                </Select.Option>
              ))}
            </Select>
          </Form.Item>
          <Form.Item label="ÊùÉÈáçÂÄº" style={{ marginBottom: 8 }}>
            <Input
              placeholder="ËØ∑ËæìÂÖ•ÊùÉÈáçÂÄº"
              value={data.weightValue || ''}
              onChange={(e) => handleChange('weightValue', e.target.value)}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
          <Form.Item label="ÁªìÊûúËæìÂá∫" style={{ marginBottom: 8 }}>
            <Input.TextArea
              placeholder="ËØ∑ËæìÂÖ•ÁªìÊûúËæìÂá∫"
              value={data.resultOutput || ''}
              onChange={(e) => handleChange('resultOutput', e.target.value)}
              autoSize={{ minRows: 2, maxRows: 4 }}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
        </>
      )}
    </div>
  );
};

// Ê∑ªÂä† AnalysisResourceForm ÁªÑ‰ª∂
const AnalysisResourceForm = ({ data, onChange, isExpanded }) => {
  const handleChange = (field, value) => {
    onChange({
      ...data,
      [field]: value
    });
  };

  return (
    <div>
      <Form.Item label="ÂàÜÊûêËµÑÊ∫êID" style={{ marginBottom: 8 }}>
        <Input
          placeholder="ËØ∑ËæìÂÖ•ÂàÜÊûêËµÑÊ∫êID"
          value={data.resourceId || ''}
          onChange={(e) => handleChange('resourceId', e.target.value)}
          onClick={(e) => e.stopPropagation()}
        />
      </Form.Item>
      {isExpanded && (
        <>
          <Form.Item label="‰∏≠ÊñáÂΩìÂâçÂÄº" style={{ marginBottom: 8 }}>
            <Input.TextArea
              placeholder="ËØ∑ËæìÂÖ•‰∏≠ÊñáÂΩìÂâçÂÄº"
              value={data.chCurrentValue || ''}
              onChange={(e) => handleChange('chCurrentValue', e.target.value)}
              autoSize={{ minRows: 1, maxRows: 3 }}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
          <Form.Item label="‰∏≠ÊñáÂ§ÑÁêÜÂª∫ËÆÆ" style={{ marginBottom: 8 }}>
            <Input.TextArea
              placeholder="ËØ∑ËæìÂÖ•‰∏≠ÊñáÂ§ÑÁêÜÂª∫ËÆÆ"
              value={data.chSuggestion || ''}
              onChange={(e) => handleChange('chSuggestion', e.target.value)}
              autoSize={{ minRows: 1, maxRows: 3 }}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
          <Form.Item label="Ëã±ÊñáÂΩìÂâçÂÄº" style={{ marginBottom: 8 }}>
            <Input.TextArea
              placeholder="ËØ∑ËæìÂÖ•Ëã±ÊñáÂΩìÂâçÂÄº"
              value={data.enCurrentValue || ''}
              onChange={(e) => handleChange('enCurrentValue', e.target.value)}
              autoSize={{ minRows: 1, maxRows: 3 }}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
          <Form.Item label="Ëã±ÊñáÂ§ÑÁêÜÂª∫ËÆÆ" style={{ marginBottom: 8 }}>
            <Input.TextArea
              placeholder="ËØ∑ËæìÂÖ•Ëã±ÊñáÂ§ÑÁêÜÂª∫ËÆÆ"
              value={data.enSuggestion || ''}
              onChange={(e) => handleChange('enSuggestion', e.target.value)}
              autoSize={{ minRows: 1, maxRows: 3 }}
              onClick={(e) => e.stopPropagation()}
            />
          </Form.Item>
        </>
      )}
    </div>
  );
};

// Ëá™ÂÆö‰πâËäÇÁÇπÁªÑ‰ª∂
const CustomNode = ({ id, data, onDelete, onChange }) => {
  const [isExpanded, setIsExpanded] = useState(true);
  const nodeConfig = NODE_TYPES[data?.type] || {
    color: '#f0f0f0',
    borderColor: '#d9d9d9',
    label: 'Êú™Áü•ËäÇÁÇπ'
  };
  
  const handleDataChange = useCallback((nodeId, newData) => {
    console.log('Node data changed:', nodeId, newData);
    onChange(nodeId, newData);
  }, [onChange]);

  const handleStyle = {
    background: nodeConfig.borderColor,
    width: '8px',
    height: '8px'
  };

  // Ê†πÊçÆËäÇÁÇπÁ±ªÂûãÊ∏≤Êüì‰∏çÂêåÁöÑÂÜÖÂÆπ
  const renderNodeContent = () => {
    if (!data?.type) return <div>Êó†ÊïàËäÇÁÇπÁ±ªÂûã</div>;

    const commonProps = {
      data,
      onChange: (newData) => handleDataChange(id, newData),
      isExpanded
    };

    switch (data.type) {
      case 'prerequisite':
        return <PrerequisiteForm {...commonProps} />;
      case 'atomicAnalysis':
        return <AtomicAnalysisForm {...commonProps} />;
      case 'preCheck':
        return <PreCheckForm {...commonProps} />;
      case 'dataModel':
        return <DataModelForm {...commonProps} />;
      case 'analysisResult':
        return <AnalysisResultForm {...commonProps} />;
      case 'analysisResource':
        return <AnalysisResourceForm {...commonProps} />;
      default:
        return <div>{data.description || 'Êó†ÊèèËø∞'}</div>;
    }
  };

  return (
    <div 
      style={{ position: 'relative' }}
      onClick={e => e.stopPropagation()}
    >
      <Card
        size="small"
        title={data?.title || 'Êú™ÂëΩÂêçËäÇÁÇπ'}
        style={{
          width: ['prerequisite', 'atomicAnalysis', 'preCheck', 'dataModel', 'analysisResult'].includes(data?.type) ? 300 : 200,
          backgroundColor: nodeConfig.color,
          borderColor: nodeConfig.borderColor,
        }}
        extra={
          <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
            {isExpanded ? (
              <UpOutlined
                style={{
                  color: '#999',
                  cursor: 'pointer',
                  transition: 'transform 0.2s',
                }}
                onClick={(e) => {
                  e.stopPropagation();
                  setIsExpanded(false);
                }}
              />
            ) : (
              <DownOutlined
                style={{
                  color: '#999',
                  cursor: 'pointer',
                  transition: 'transform 0.2s',
                }}
                onClick={(e) => {
                  e.stopPropagation();
                  setIsExpanded(true);
                }}
              />
            )}
            <DeleteOutlined
              style={{
                color: '#999',
                cursor: 'pointer',
                transition: 'transform 0.2s',
              }}
              onClick={(e) => {
                e.stopPropagation();
                onDelete(id);
              }}
            />
          </div>
        }
      >
        {renderNodeContent()}
      </Card>
      <Handle type="target" position={Position.Top} id={`${id}-top`} style={handleStyle} />
      <Handle type="target" position={Position.Left} id={`${id}-left`} style={handleStyle} />
      <Handle type="source" position={Position.Right} id={`${id}-right`} style={handleStyle} />
      <Handle type="source" position={Position.Bottom} id={`${id}-bottom`} style={handleStyle} />
    </div>
  );
};

// ‰∏ªÁªÑ‰ª∂
const FlowChart = () => {
  const reactFlowInstance = useReactFlow();
  const [nodes, setNodes] = useState([]);
  const [edges, setEdges] = useState([]);
  const [contextMenu, setContextMenu] = useState(null);
  const [searchText, setSearchText] = useState('');
  const [clipboard, setClipboard] = useState(null);

  const onNodesChange = useCallback(
    (changes) => setNodes((nds) => applyNodeChanges(changes, nds)),
    []
  );

  const onEdgesChange = useCallback(
    (changes) => setEdges((eds) => applyEdgeChanges(changes, eds)),
    []
  );

  // Â∞Ü isValidConnection ÂåÖË£ÖÂú® useCallback ‰∏≠
  const isValidConnection = useCallback((connection) => {
    const { source, target } = connection;
    
    // Ëé∑ÂèñÊ∫êËäÇÁÇπÂíåÁõÆÊ†áËäÇÁÇπ
    const sourceNode = nodes.find(node => node.id === source);
    const targetNode = nodes.find(node => node.id === target);

    if (!sourceNode || !targetNode) {
      return false;
    }

    // ÂâçÁΩÆÊ£ÄÊü•ËäÇÁÇπÁöÑËøûÊé•ËßÑÂàô
    if (sourceNode.data.type === 'prerequisite') {
      if (targetNode.data.type !== 'preCheck') {
        message.error('ÂâçÁΩÆÊ£ÄÊü•ËäÇÁÇπÂè™ËÉΩËøûÊé•Âà∞ÊâßË°åÂâçÊ£ÄÊü•ËäÇÁÇπ');
        return false;
      }
      return true;
    }

    // ÊâßË°åÂâçÊ£ÄÊü•ËäÇÁÇπÁöÑËøûÊé•ËßÑÂàô
    if (sourceNode.data.type === 'preCheck') {
      if (targetNode.data.type !== 'atomicAnalysis' && targetNode.data.type !== 'analysisResult') {
        message.error('ÊâßË°åÂâçÊ£ÄÊü•ËäÇÁÇπÂè™ËÉΩËøûÊé•Âà∞ÂàÜÊûêÂéüÂ≠êËäÇÁÇπÊàñÂàÜÊûêÁªìÊûúËäÇÁÇπ');
        return false;
      }
      return true;
    }

    // Êï∞ÊçÆÊ®°ÂûãËäÇÁÇπÁöÑËøûÊé•ËßÑÂàô
    if (sourceNode.data.type === 'dataModel') {
      if (targetNode.data.type !== 'atomicAnalysis' && targetNode.data.type !== 'dataModel') {
        message.error('Êï∞ÊçÆÊ®°ÂûãËäÇÁÇπÂè™ËÉΩËøûÊé•Âà∞ÂàÜÊûêÂéüÂ≠êËäÇÁÇπÊàñÂÖ∂‰ªñÊï∞ÊçÆÊ®°ÂûãËäÇÁÇπ');
        return false;
      }
      return true;
    }

    // ÂÖ∂‰ªñÁ±ªÂûãËäÇÁÇπÁöÑËøûÊé•ËßÑÂàô
    return true;
  }, [nodes]);

  const onConnectStart = useCallback((event, { nodeId, handleType }) => {
    const sourceNode = nodes.find(node => node.id === nodeId);
    
    if (!sourceNode) return;

    setNodes((nds) =>
      nds.map((node) => {
        if (sourceNode.data.type === 'prerequisite') {
          // Â¶ÇÊûúÊòØÂâçÁΩÆÊ£ÄÊü•ËäÇÁÇπÔºåÂè™È´ò‰∫ÆÊòæÁ§∫ÊâßË°åÂâçÊ£ÄÊü•ËäÇÁÇπ
          return {
            ...node,
            style: {
              ...node.style,
              opacity: node.data.type === 'preCheck' ? 1 : 0.2,
            },
          };
        } else if (sourceNode.data.type === 'preCheck') {
          // Â¶ÇÊûúÊòØÊâßË°åÂâçÊ£ÄÊü•ËäÇÁÇπÔºåÂè™È´ò‰∫ÆÊòæÁ§∫ÂàÜÊûêÂéüÂ≠êÂíåÂàÜÊûêÁªìÊûúËäÇÁÇπ
          return {
            ...node,
            style: {
              ...node.style,
              opacity: (node.data.type === 'atomicAnalysis' || node.data.type === 'analysisResult') ? 1 : 0.2,
            },
          };
        } else if (sourceNode.data.type === 'dataModel') {
          // Êï∞ÊçÆÊ®°ÂûãËäÇÁÇπÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
          return {
            ...node,
            style: {
              ...node.style,
              opacity: (node.data.type === 'atomicAnalysis' || node.data.type === 'dataModel') ? 1 : 0.2,
            },
          };
        }
        // ÂÖ∂‰ªñËäÇÁÇπÁ±ªÂûãÁöÑËøûÊé•ÈÄªËæë‰øùÊåÅ‰∏çÂèò
        return {
          ...node,
          style: {
            ...node.style,
            opacity: 1,
          },
        };
      })
    );
  }, [nodes]);

  const onConnectEnd = useCallback(() => {
    setNodes((nds) =>
      nds.map((node) => ({
        ...node,
        style: {
          ...node.style,
          opacity: 1,
        },
      }))
    );
  }, []);

  const onConnect = useCallback((connection) => {
    if (isValidConnection(connection)) {
      setEdges((eds) => addEdge(connection, eds));
    }
  }, [isValidConnection]);

  const handleDrop = useCallback(
    (event) => {
      event.preventDefault();

      const nodeType = event.dataTransfer.getData('nodeType');
      if (!nodeType || !NODE_TYPES[nodeType]) {
        console.error('Invalid node type:', nodeType);
        return;
      }

      const reactFlowBounds = document.querySelector('.react-flow').getBoundingClientRect();
      const position = reactFlowInstance.project({
        x: event.clientX - reactFlowBounds.left,
        y: event.clientY - reactFlowBounds.top,
      });

      let initialData = {
        title: NODE_TYPES[nodeType].label,
        type: nodeType,
        description: 'ÂèåÂáªÁºñËæëÊèèËø∞'
      };

      switch (nodeType) {
        case 'prerequisite':
          initialData = {
            ...initialData,
            conditions: {
              device: '',
              subRack: '',
              board: ''
            },
            caseId: '',
            isActive: true
          };
          break;
        case 'atomicAnalysis':
          initialData = {
            ...initialData,
            atomicId: '',
            analysisRule: '',
            parameterRefresh: ''
          };
          break;
        case 'preCheck':
          initialData = {
            ...initialData,
            analysisItemId: '',
            checkCondition: ''
          };
          break;
        case 'dataModel':
          initialData = {
            ...initialData,
            modelId: '',
            parseType: 'dump_table_value',
            command: '',
            parameters: '',
            startMark: '',
            endMark: '',
            lineRegex: '',
            tableHeader: '',
            extraOperation: '',
            joinType: 'left_join',
            joinFields: ''
          };
          break;
        case 'analysisResult':
          initialData = {
            ...initialData,
            resultId: '',
            severityLevel: 'hint',  // Êîπ‰∏∫ severityLevelÔºåÈªòËÆ§ÈÄâÊã©"ÊèêÁ§∫"
            weightValue: '',
            resultOutput: ''
          };
          break;
        case 'analysisResource':
          initialData = {
            ...initialData,
            resourceId: '',
            chCurrentValue: '',   // ‰∏≠ÊñáÂΩìÂâçÂÄº
            chSuggestion: '',     // ‰∏≠ÊñáÂ§ÑÁêÜÂª∫ËÆÆ
            enCurrentValue: '',   // Ëã±ÊñáÂΩìÂâçÂÄº
            enSuggestion: ''      // Ëã±ÊñáÂ§ÑÁêÜÂª∫ËÆÆ
          };
          break;
        default:
          console.warn(`Êú™Áü•ÁöÑËäÇÁÇπÁ±ªÂûã: ${nodeType}`);
          break;
      }

      const newNode = {
        id: `node${nodes.length + 1}`,
        type: 'custom',
        position,
        data: initialData
      };

      setNodes((nds) => [...nds, newNode]);
    },
    [nodes, reactFlowInstance]
  );

  const handleDragOver = useCallback((event) => {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
  }, []);

  const onNodeContextMenu = useCallback((event, node) => {
    event.preventDefault();
    setContextMenu({
      x: event.clientX,
      y: event.clientY,
      node: node
    });
  }, []);

  const onPaneClick = useCallback(() => {
    setContextMenu(null);
  }, []);

  const onDeleteNode = useCallback((nodeId) => {
    setNodes((nodes) => nodes.filter((node) => node.id !== nodeId));
    setEdges((edges) => edges.filter(
      (edge) => edge.source !== nodeId && edge.target !== nodeId
    ));
    setContextMenu(null);
  }, []);

  const updateNodeData = useCallback((nodeId, newData) => {
    setNodes((nds) =>
      nds.map((node) => {
        if (node.id === nodeId) {
          return {
            ...node,
            data: {
              ...node.data,
              ...newData
            }
          };
        }
        return node;
      })
    );
  }, []);

  const nodeTypes = useMemo(
    () => ({
      custom: (props) => (
        <CustomNode
          {...props}
          onDelete={onDeleteNode}
          onChange={updateNodeData}
        />
      ),
    }),
    [onDeleteNode, updateNodeData]
  );

  const filteredNodeTypes = Object.entries(NODE_TYPES).filter(([_, config]) =>
    config.label.toLowerCase().includes(searchText.toLowerCase())
  );

  // Â§ÑÁêÜÈîÆÁõò‰∫ã‰ª∂
  const onKeyDown = useCallback(
    (event) => {
      // Ê£ÄÊü•ÊòØÂê¶Êåâ‰∏ã‰∫Ü Ctrl ÈîÆ (Windows) Êàñ Command ÈîÆ (Mac)
      const isCtrlPressed = event.ctrlKey || event.metaKey;
      
      // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËäÇÁÇπ
      const selectedNodes = nodes.filter(node => node.selected);

      if (isCtrlPressed && event.key === 'c' && selectedNodes.length > 0) {
        // Â§çÂà∂Êìç‰Ωú
        const nodesToCopy = selectedNodes.map(node => ({
          ...node,
          id: `${node.id}-copy`, // ‰∏¥Êó∂IDÔºåÂÆûÈôÖÁ≤òË¥¥Êó∂‰ºöÊõ¥Êñ∞
          position: { ...node.position },
          data: { ...node.data }
        }));
        setClipboard(nodesToCopy);
        event.preventDefault();
      }

      if (isCtrlPressed && event.key === 'v' && clipboard) {
        // Á≤òË¥¥Êìç‰Ωú
        const now = Date.now();
        const newNodes = clipboard.map((node, index) => ({
          ...node,
          id: `node-${now}-${index}`,
          position: {
            x: node.position.x + 50, // ÂÅèÁßª‰ΩçÁΩÆÔºåÈÅøÂÖçÂÆåÂÖ®ÈáçÂè†
            y: node.position.y + 50
          },
          selected: false
        }));

        setNodes((nds) => [...nds, ...newNodes]);
        event.preventDefault();
      }
    },
    [nodes, clipboard]
  );

  // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
  useEffect(() => {
    document.addEventListener('keydown', onKeyDown);
    return () => {
      document.removeEventListener('keydown', onKeyDown);
    };
  }, [onKeyDown]);

  return (
    <Layout style={{ height: '100vh', width: '100%' }}>
      <Content style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
        <div style={{ 
          padding: '10px', 
          borderBottom: '1px solid #ddd',
          background: '#fff',
          boxShadow: '0 2px 5px rgba(0,0,0,0.1)'
        }}>
          <Space>
            <Button type="primary">‰øùÂ≠ò</Button>
            <Button>Êí§ÈîÄ</Button>
            <Button>ÈáçÂÅö</Button>
          </Space>
        </div>

        <div style={{ display: 'flex', flex: 1 }}>
          <div style={{ flex: 1 }}>
            <ReactFlow
              nodes={nodes}
              edges={edges}
              nodeTypes={nodeTypes}
              onNodesChange={onNodesChange}
              onEdgesChange={onEdgesChange}
              onConnect={onConnect}
              onDrop={handleDrop}
              onDragOver={handleDragOver}
              onNodeContextMenu={onNodeContextMenu}
              onPaneClick={onPaneClick}
              onConnectStart={onConnectStart}
              onConnectEnd={onConnectEnd}
              fitView
              style={{ background: '#f0f2f5' }}
              defaultEdgeOptions={{
                type: 'smoothstep',
                animated: true,
                style: { stroke: '#555' },
                markerEnd: {
                  type: 'arrowclosed',
                  width: 20,
                  height: 20,
                  color: '#555',
                },
              }}
              selectionMode={1}
              selectNodesOnDrag={true}
              multiSelectionKeyCode={['Control', 'Meta']}
              deleteKeyCode={['Backspace', 'Delete']}
            >
              <Background />
              <Controls />
              <MiniMap />
            </ReactFlow>
          </div>

          <div style={{ 
            width: 300, 
            backgroundColor: '#fff', 
            borderLeft: '1px solid #ddd',
            padding: '20px',
            display: 'flex',
            flexDirection: 'column',
            gap: '16px'
          }}>
            <Input.Search
              placeholder="ÊêúÁ¥¢ËäÇÁÇπÁ±ªÂûã"
              onChange={(e) => setSearchText(e.target.value)}
              style={{ width: '100%' }}
            />
            
            <Divider>ËäÇÁÇπÁ±ªÂûã</Divider>
            
            <Space direction="vertical" style={{ width: '100%' }}>
              {filteredNodeTypes.map(([key, config]) => (
                <Card
                  key={key}
                  size="small"
                  style={{
                    backgroundColor: config.color,
                    borderColor: config.borderColor,
                    cursor: 'move',
                    marginBottom: '8px',
                  }}
                  draggable
                  onDragStart={(event) => {
                    event.dataTransfer.setData('nodeType', key);
                    event.dataTransfer.effectAllowed = 'move';
                  }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span>{config.icon}</span>
                    <span>{config.label}</span>
                  </div>
                </Card>
              ))}
            </Space>
          </div>
        </div>

        {contextMenu && (
          <Dropdown
            open={true}
            trigger={[]}
            overlay={
              <Menu>
                <Menu.Item
                  key="delete"
                  onClick={() => onDeleteNode(contextMenu.node.id)}
                >
                  Âà†Èô§ËäÇÁÇπ
                </Menu.Item>
              </Menu>
            }
            style={{
              position: 'fixed',
              left: contextMenu.x,
              top: contextMenu.y,
            }}
          />
        )}
      </Content>
    </Layout>
  );
};

export default function FlowChartWrapper() {
  return (
    <ReactFlowProvider>
      <FlowChart />
    </ReactFlowProvider>
  );
}